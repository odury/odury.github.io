<h1>Calculadora metros cuadrados</h1>

Barrio:
<br>
<select name="barrio" id="barrio" onchange="fetcher()">
</select>
<br>

Renta anual:
<br>
<select name="renta_anual" id="renta_anual" onchange="fetcher()">
</select>
<br>
Metros cuadrados:
<br>
<div id="precio">
</div>


<h1>Calculadora esfuerzo financiero</h1>

Edad?:
<br>
<input type="number" id="age" name="ge" min="1" max="200" value="30" onchange="mortgageCalculator()">
años
<br>

Cual es mi salario neto medio anual?:
<br>
<input type="number" id="salary" name="salary" min="1" max="999999999" value="30000" onchange="mortgageCalculator()">
euros
<br>

Cuando cuesta mi casa?:
<br>
<input type="number" id="price" name="price" min="0" max="999999999" value="170000" onchange="mortgageCalculator()">
euros
<br>

Entrada?:
<br>
<input type="number" id="down" name="down" min="0" max="999999999" value="34000" onchange="mortgageCalculator()"> euros
<br>

Duracion de la hipoteca?:
<br>
<input type="number" id="years" name="years" min="1" max="100" value="30" onchange="mortgageCalculator()"> años
<br>

Que interes me ofrece el banco?:
<br>
<input type="number" id="interest" name="interest" min="0" max="100" value="1.75" step="0.01"
    onchange="mortgageCalculator()">%
<br>

Cuota mensual: <div id="payment"></div> euros
<br>
Coste total hipoteca: <div id="totalcost"></div> euros
<br>
Coste total intereses: <div id="totalinterests"></div> euros
<br>
Pagar la hipoteca me requiere <div id="weeksfortotalcost"></div> semanas de trabajo ademas de lo que me ha costado
ahorrar
la entrada.
<br>
Pagar el capital de la hipoteca me requiere <div id="weeksforcapital"></div> semanas de trabajo ademas de lo que me ha
costado ahorrar la entrada.
<br>
Pagar los intereses de la hipoteca me requiere <div id="weeksforinterests"></div> semanas de trabajo ademas de lo que me
ha
costado ahorrar la entrada.
<br>
<div id="chart"></div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"
    integrity="sha512-EbdJQSugx0nVWrtyK3JdQQ/03mS3Q1UiAhRtErbwl1YL/+e2hZdlIcSURxxh7WXHTzn83sjlh2rysACoJGfb6g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.29.0/apexcharts.min.js"
    integrity="sha512-fe6OklXva8AWoqdwgkE7Ni4uWgHGWxFQWZx4lYehzY2Qrst5YfogjAbnLd6egsoTrnjGI9/LYt1Ont2cKNbP2A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    function generatebarrios(data) {
        // get uniques
        var uniques = data.reduce(function (a, d) {
            if (a.indexOf(d.barrio) === -1) {
                a.push(d.barrio);
            }
            return a;
        }, []);
        // remove nulls
        uniques = uniques.filter(n => n)
        // populate options
        let optionList = document.getElementById('barrio').options;
        uniques.forEach(option =>
            optionList.add(
                new Option(option, option)
            )
        );
    }
    function generaterentas(data) {
        // get uniques
        var uniques = data.reduce(function (a, d) {
            if (a.indexOf(d.renta_anual) === -1) {
                a.push(d.renta_anual);
            }
            return a;
        }, []);
        // remove nulls
        uniques = uniques.filter(n => n)
        // populate options
        let optionList = document.getElementById('renta_anual').options;
        uniques.forEach(option =>
            optionList.add(
                new Option(option, option)
            )
        );
    }

    function changer(data) {
        // change result
        var barrio = document.getElementById('barrio').value
        var renta_anual = document.getElementById('renta_anual').value
        var fetched = data.filter(a => a.barrio == barrio && a.renta_anual == renta_anual);
        document.getElementById("precio").innerHTML = fetched[0]["m2"]
    }
    function fetcher() {
        // load data
        Papa.parse('./data/bbdd_elrealista.csv', {
            header: true,
            download: true,
            dynamicTyping: true,
            complete: function (results) {
                generatebarrios(results.data)
                generaterentas(results.data)
                changer(results.data)
            }
        });
    }

    fetcher()

    function mortgageCalculator() {
        var salary = document.getElementById('salary').value
        var price = document.getElementById('price').value
        var down = document.getElementById('down').value
        var years = document.getElementById('years').value
        var monthlyinterest = document.getElementById('interest').value / 100 / 12
        var monthlypayment = (price - down) / ((1 - ((1 + monthlyinterest) ** (-years * 12))) / monthlyinterest)
        var totalcost = monthlypayment * 12 * years
        var weeklysalary = salary / 52
        document.getElementById("payment").innerHTML = Math.round(monthlypayment * 100) / 100
        document.getElementById("totalcost").innerHTML = Math.round(totalcost * 100) / 100
        document.getElementById("totalinterests").innerHTML = Math.round((totalcost - price) * 100) / 100
        document.getElementById("weeksfortotalcost").innerHTML = Math.round(totalcost / weeklysalary)
        document.getElementById("weeksforcapital").innerHTML = Math.round(price / weeklysalary)
        document.getElementById("weeksforinterests").innerHTML = Math.round((totalcost - price) / weeklysalary)
    }
    mortgageCalculator()

    function plotter() {
        var weeks = parseFloat(document.getElementById("weeksfortotalcost").innerHTML)
        var age = parseFloat(document.getElementById('age').value)
        var completeyears = Math.floor(weeks / 52)
        var remainingweeks = weeks - (completeyears * 52)
        var finalagecomplete = age + completeyears
        var lastage = finalagecomplete + 1
        var series = []
        for (let step = 18; step < 91; step++) {
            if (step === (finalagecomplete+1)) {
                var weekslst = []
                for (let wstep = 1; wstep < 53; wstep++) {
                    if (wstep <= remainingweeks) {
                        weekslst.push(1)
                    } else {
                        weekslst.push(0)
                    }
                }
                var serie = {
                    name: step,
                    data: weekslst
                }
                series.push(serie)
            } else if (step >= age && step <= finalagecomplete) {
                var serie = {
                    name: step,
                    data: Array(52).fill(1)
                }
                series.push(serie)
            } else {
                var serie = {
                    name: step,
                    data: Array(52).fill(0)
                }
                series.push(serie)                
            }
        }
        var options = {
            series: series,
            chart: {
                height: 1350,
                type: 'heatmap',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 80,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            title: {
                text: 'La parte de mi vida que se lleva la hipoteca'
            },
            yaxis: {
                title: { text: 'Edad' },
                reversed: true
            },
            xaxis: {
                title: { text: 'Semana' },
            },
            legend: {
                show: false,
            },
            plotOptions: {
                heatmap: {
                    radius: 2,
                    enableShades: true,
                    shadeIntensity: 0.5,
                    reverseNegativeShade: true,
                    distributed: false,
                    useFillColorAsStroke: false,
                    colorScale: {
                        ranges: [{
                            from: 0,
                            to: 0.5,
                            color: "#008FFB",
                        }, {
                            from: 0.5,
                            to: 1,
                            color: "#ff0000",
                        }],
                        inverse: false,
                        min: undefined,
                        max: undefined
                    },
                }
            },
        };
        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }
    plotter()
</script>